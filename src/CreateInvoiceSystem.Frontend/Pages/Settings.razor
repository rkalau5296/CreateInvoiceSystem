@page "/settings"
@using System.ComponentModel.DataAnnotations
@using System.Linq.Expressions
@using System.Reflection
@using Microsoft.AspNetCore.Components.Forms
@using CreateInvoiceSystem.Frontend.Models
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<h3 class="mb-4">Ustawienia Konta i Firmy</h3>

@if (userModel == null)
{
    <div class="d-flex align-items-center">
        <div class="spinner-border me-2" role="status"></div>
        <span>Ładowanie Twoich ustawień...</span>
    </div>
}
else
{
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Dane profilu i firmy</h5>
        </div>
        <div class="card-body">
            <ValidatedEditForm TModel="UpdateUserDto" Model="userModel" OnValidSubmit="HandleValidSubmit">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            Imię i Nazwisko
                            @if (IsRequired(() => userModel.Name))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText class="@($"form-control {GetFieldClass(() => userModel.Name)}")"
                                   @bind-Value="userModel.Name"
                                   @oninput="(ChangeEventArgs __e) => MarkModified(() => userModel.Name)" />
                        @if (IsFieldModified(() => userModel.Name) && !GetValidationMessages(() => userModel.Name).Any())
                        {
                            <div class="valid-feedback d-block">Wygląda dobrze.</div>
                        }
                        @foreach (var m in GetValidationMessages(() => userModel.Name))
                        {
                            <div class="invalid-feedback d-block">@m</div>
                        }
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            Pełna Nazwa Firmy
                            @if (IsRequired(() => userModel.CompanyName))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText class="@($"form-control {GetFieldClass(() => userModel.CompanyName)}")"
                                   @bind-Value="userModel.CompanyName"
                                   @oninput="(ChangeEventArgs __e) => MarkModified(() => userModel.CompanyName)" />
                        @if (IsFieldModified(() => userModel.CompanyName) && !GetValidationMessages(() => userModel.CompanyName).Any())
                        {
                            <div class="valid-feedback d-block">Wygląda dobrze.</div>
                        }
                        @foreach (var m in GetValidationMessages(() => userModel.CompanyName))
                        {
                            <div class="invalid-feedback d-block">@m</div>
                        }
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            Email
                            @if (IsRequired(() => userModel.Email))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText class="@($"form-control {GetFieldClass(() => userModel.Email)}")"
                                   @bind-Value="userModel.Email"
                                   @oninput="(ChangeEventArgs __e) => MarkModified(() => userModel.Email)" />
                        @if (IsFieldModified(() => userModel.Email) && !GetValidationMessages(() => userModel.Email).Any())
                        {
                            <div class="valid-feedback d-block">Adres email jest poprawny.</div>
                        }
                        @foreach (var m in GetValidationMessages(() => userModel.Email))
                        {
                            <div class="invalid-feedback d-block">@m</div>
                        }
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            NIP
                            @if (IsRequired(() => userModel.Nip))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText class="@($"form-control {GetFieldClass(() => userModel.Nip)}")"
                                   @bind-Value="userModel.Nip"
                                   @oninput="(ChangeEventArgs __e) => MarkModified(() => userModel.Nip)" />
                        @if (IsFieldModified(() => userModel.Nip) && !GetValidationMessages(() => userModel.Nip).Any())
                        {
                            <div class="valid-feedback d-block">NIP wygląda poprawnie.</div>
                        }
                        @foreach (var m in GetValidationMessages(() => userModel.Nip))
                        {
                            <div class="invalid-feedback d-block">@m</div>
                        }
                    </div>

                    <div class="col-md-12">
                        <label class="form-label fw-bold">
                            Numer konta bankowego
                            @if (IsRequired(() => userModel.BankAccountNumber))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText class="@($"form-control {GetFieldClass(() => userModel.BankAccountNumber)}")"
                                   @bind-Value="userModel.BankAccountNumber"
                                   @oninput="(ChangeEventArgs __e) => MarkModified(() => userModel.BankAccountNumber)" />
                        @if (IsFieldModified(() => userModel.BankAccountNumber) && !GetValidationMessages(() => userModel.BankAccountNumber).Any())
                        {
                            <div class="valid-feedback d-block">Numer konta wygląda dobrze.</div>
                        }
                        @foreach (var m in GetValidationMessages(() => userModel.BankAccountNumber))
                        {
                            <div class="invalid-feedback d-block">@m</div>
                        }
                    </div>

                    <hr class="my-4" />
                    <h5 class="text-secondary">Adres siedziby</h5>

                    <div class="col-md-9">
                        <label class="form-label">
                            Ulica
                            @if (IsRequired(() => userModel.Address.Street))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText class="@($"form-control {GetFieldClass(() => userModel.Address.Street)}")"
                                   @bind-Value="userModel.Address.Street"
                                   @oninput="(ChangeEventArgs __e) => MarkModified(() => userModel.Address.Street)" />
                        @if (IsFieldModified(() => userModel.Address.Street) && !GetValidationMessages(() => userModel.Address.Street).Any())
                        {
                            <div class="valid-feedback d-block">Wygląda dobrze.</div>
                        }
                        @foreach (var m in GetValidationMessages(() => userModel.Address.Street))
                        {
                            <div class="invalid-feedback d-block">@m</div>
                        }
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">
                            Nr budynku
                            @if (IsRequired(() => userModel.Address.Number))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText class="@($"form-control {GetFieldClass(() => userModel.Address.Number)}")"
                                   @bind-Value="userModel.Address.Number"
                                   @oninput="(ChangeEventArgs __e) => MarkModified(() => userModel.Address.Number)" />
                        @if (IsFieldModified(() => userModel.Address.Number) && !GetValidationMessages(() => userModel.Address.Number).Any())
                        {
                            <div class="valid-feedback d-block">Wygląda dobrze.</div>
                        }
                        @foreach (var m in GetValidationMessages(() => userModel.Address.Number))
                        {
                            <div class="invalid-feedback d-block">@m</div>
                        }
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">
                            Kod pocztowy
                            @if (IsRequired(() => userModel.Address.PostalCode))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText class="@($"form-control {GetFieldClass(() => userModel.Address.PostalCode)}")"
                                   @bind-Value="userModel.Address.PostalCode"
                                   @oninput="(ChangeEventArgs __e) => MarkModified(() => userModel.Address.PostalCode)" />
                        @if (IsFieldModified(() => userModel.Address.PostalCode) && !GetValidationMessages(() => userModel.Address.PostalCode).Any())
                        {
                            <div class="valid-feedback d-block">Wygląda dobrze.</div>
                        }
                        @foreach (var m in GetValidationMessages(() => userModel.Address.PostalCode))
                        {
                            <div class="invalid-feedback d-block">@m</div>
                        }
                    </div>

                    <div class="col-md-8">
                        <label class="form-label">
                            Miasto
                            @if (IsRequired(() => userModel.Address.City))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText class="@($"form-control {GetFieldClass(() => userModel.Address.City)}")"
                                   @bind-Value="userModel.Address.City"
                                   @oninput="(ChangeEventArgs __e) => MarkModified(() => userModel.Address.City)" />
                        @if (IsFieldModified(() => userModel.Address.City) && !GetValidationMessages(() => userModel.Address.City).Any())
                        {
                            <div class="valid-feedback d-block">Wygląda dobrze.</div>
                        }
                        @foreach (var m in GetValidationMessages(() => userModel.Address.City))
                        {
                            <div class="invalid-feedback d-block">@m</div>
                        }
                    </div>

                    <div class="col-md-8">
                        <label class="form-label">
                            Kraj
                            @if (IsRequired(() => userModel.Address.Country))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText class="@($"form-control {GetFieldClass(() => userModel.Address.Country)}")"
                                   @bind-Value="userModel.Address.Country"
                                   @oninput="(ChangeEventArgs __e) => MarkModified(() => userModel.Address.Country)" />
                        @if (IsFieldModified(() => userModel.Address.Country) && !GetValidationMessages(() => userModel.Address.Country).Any())
                        {
                            <div class="valid-feedback d-block">Wygląda dobrze.</div>
                        }
                        @foreach (var m in GetValidationMessages(() => userModel.Address.Country))
                        {
                            <div class="invalid-feedback d-block">@m</div>
                        }
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-success px-4" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Zapisz zmiany
                    </button>
                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <span class="ms-3 alert @statusClass p-2">@statusMessage</span>
                    }
                </div>
            </ValidatedEditForm>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-body">
            <h5>Bezpieczeństwo</h5>
            <p class="text-muted small">Zalecamy regularną zmianę hasła dla ochrony Twoich danych fakturowych.</p>
            <a href="/change-password" class="btn btn-outline-warning">
                <i class="bi bi-shield-lock"></i> Zmień hasło dostępu
            </a>
        </div>
    </div>
}

@code {
    private UpdateUserDto? userModel;
    private bool isSubmitting = false;
    private string statusMessage = "";
    private string statusClass = "";
    private readonly HashSet<string> _modifiedFields = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<GetMeResponse>("api/User/me");

            if (response?.Data != null)
            {
                var userData = response.Data;
                userModel = new UpdateUserDto
                {
                    UserId = userData.UserId,
                    Name = userData.Name,
                    CompanyName = userData.CompanyName,
                    Email = userData.Email,
                    Nip = userData.Nip,
                    BankAccountNumber = userData.BankAccountNumber,
                    Address = new UpdateAddressDto
                    {
                        Street = userData.Address.Street,
                        Number = userData.Address.Number,
                        PostalCode = userData.Address.PostalCode,
                        City = userData.Address.City,
                        Country = userData.Address.Country
                    }
                };
            }
        }
        catch (Exception)
        {
            statusMessage = "Błąd autoryzacji sesji.";
            statusClass = "alert-danger";
            userModel = new UpdateUserDto();
        }
    }

    private async Task HandleValidSubmit()
    {
        if (userModel == null) return;
        isSubmitting = true;
        statusMessage = "";
        statusClass = "";

        try
        {
            var response = await Http.PutAsJsonAsync($"api/User/update/{userModel.UserId}", userModel);
            if (response.IsSuccessStatusCode)
            {
                statusMessage = "Ustawienia zapisane!";
                statusClass = "alert-success";
            }
            else
            {
                string serverMsg = await response.Content.ReadAsStringAsync();
                statusMessage = string.IsNullOrWhiteSpace(serverMsg) ? "Błąd podczas zapisu na serwerze." : serverMsg;
                statusClass = "alert-danger";
            }
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private IEnumerable<string> GetValidationMessages<T>(Expression<Func<T>> accessor)
    {
        var (target, prop) = GetTargetAndProperty(accessor);
        if (target == null || prop == null) return Enumerable.Empty<string>();

        var results = new List<ValidationResult>();
        var ctx = new ValidationContext(target) { MemberName = prop.Name };
        Validator.TryValidateProperty(prop.GetValue(target), ctx, results);
        return results.Select(r => r.ErrorMessage).Where(m => !string.IsNullOrWhiteSpace(m));
    }

    private bool IsFieldModified<T>(Expression<Func<T>> accessor)
    {
        var path = GetPropertyPath(accessor);
        return _modifiedFields.Contains(path);
    }

    private void MarkModified<T>(Expression<Func<T>> accessor)
    {
        var path = GetPropertyPath(accessor);
        if (!_modifiedFields.Contains(path))
        {
            _modifiedFields.Add(path);
            InvokeAsync(StateHasChanged);
        }
    }

    private bool IsRequired<T>(Expression<Func<T>> accessor)
    {
        MemberExpression? member = accessor.Body as MemberExpression;
        if (member == null && accessor.Body is UnaryExpression ue && ue.Operand is MemberExpression me)
        {
            member = me;
        }

        if (member == null) return false;

        if (member.Member is PropertyInfo prop)
        {
            if (Attribute.IsDefined(prop, typeof(RequiredAttribute))) return true;
            var getMethod = prop.GetGetMethod(true);
            if (getMethod != null && Attribute.IsDefined(getMethod, typeof(RequiredAttribute))) return true;
        }

        return false;
    }

    private string GetFieldClass<T>(Expression<Func<T>> accessor)
    {
        var (target, prop) = GetTargetAndProperty(accessor);
        if (target == null || prop == null) return "";

        var messages = GetValidationMessages(accessor);
        if (messages.Any()) return "is-invalid";

        var path = GetPropertyPath(accessor);
        if (!_modified_fields_contains(path: path)) return "";

        return "is-valid";
    }

    private bool _modified_fields_contains(string path) => _modified_fields_internal().Contains(path);
    private HashSet<string> _modified_fields_internal() => _modifiedFields;

    private (object? targetInstance, PropertyInfo? property) GetTargetAndProperty<T>(Expression<Func<T>> accessor)
    {
        Expression e = accessor.Body;
        if (e is UnaryExpression ue && ue.Operand is MemberExpression)
            e = ue.Operand;

        if (e is not MemberExpression me)
            return (null, null);

        var prop = me.Member as PropertyInfo;
        if (prop == null) return (null, null);

        object? targetInstance;
        if (me.Expression is ConstantExpression constExpr)
        {
            targetInstance = constExpr.Value;
        }
        else
        {
            try
            {
                var lambda = Expression.Lambda(me.Expression);
                var fn = lambda.Compile();
                targetInstance = fn.DynamicInvoke();
            }
            catch
            {
                targetInstance = null;
            }
        }

        return (targetInstance, prop);
    }

    private string GetPropertyPath<T>(Expression<Func<T>> expr)
    {
        var parts = new List<string>();
        Expression e = expr.Body;
        if (e is UnaryExpression ue && ue.Operand is MemberExpression) e = ue.Operand;

        while (e is MemberExpression me)
        {
            parts.Insert(0, me.Member.Name);
            e = me.Expression!;
        }
        return string.Join(".", parts);
    }

    public class UpdateUserDto
    {
        public int UserId { get; set; }

        [Required(ErrorMessage = "Imię i nazwisko jest wymagane.")]
        [StringLength(100, ErrorMessage = "Maksymalnie 100 znaków.")]
        public string Name { get; set; } = string.Empty;

        [Required(ErrorMessage = "Nazwa firmy jest wymagana.")]
        [StringLength(200, ErrorMessage = "Maksymalnie 200 znaków.")]
        public string CompanyName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Email jest wymagany.")]
        [EmailAddress(ErrorMessage = "Nieprawidłowy format email.")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "NIP jest wymagany.")]
        [RegularExpression(@"^\d{10}$", ErrorMessage = "NIP musi zawierać 10 cyfr.")]
        public string Nip { get; set; } = string.Empty;

        [Required(ErrorMessage = "Numer konta jest wymagany.")]
        [StringLength(34, MinimumLength = 16, ErrorMessage = "Numer konta musi mieć od 16 do 34 znaków.")]
        public string BankAccountNumber { get; set; } = string.Empty;

        public UpdateAddressDto Address { get; set; } = new();
    }

    public class UpdateAddressDto
    {
        [Required(ErrorMessage = "Ulica jest wymagana.")]
        public string Street { get; set; } = string.Empty;

        [Required(ErrorMessage = "Nr budynku jest wymagany.")]
        public string Number { get; set; } = string.Empty;

        [Required(ErrorMessage = "Kod pocztowy jest wymagany.")]
        [RegularExpression(@"^\d{2}-\d{3}$", ErrorMessage = "Kod pocztowy musi mieć format XX-XXX.")]
        public string PostalCode { get; set; } = string.Empty;

        [Required(ErrorMessage = "Miasto jest wymagane.")]
        public string City { get; set; } = string.Empty;

        [Required(ErrorMessage = "Kraj jest wymagany.")]
        public string Country { get; set; } = "Poland";
    }

    public class GetMeResponse
    {
        public UserDtoData? Data { get; set; }
    }

    public class UserDtoData
    {
        public int UserId { get; set; }
        public string Name { get; set; } = "";
        public string CompanyName { get; set; } = "";
        public string Email { get; set; } = "";
        public string Nip { get; set; } = "";
        public string BankAccountNumber { get; set; } = "";
        public UpdateAddressDto Address { get; set; } = new();
    }
}