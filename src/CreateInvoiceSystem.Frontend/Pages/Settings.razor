@page "/settings"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using CreateInvoiceSystem.Frontend.Components
@using CreateInvoiceSystem.Frontend.Models
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-9">
            <h3 class="mb-4">Ustawienia Konta i Firmy</h3>

            @if (userModel == null)
            {
                <div class="d-flex align-items-center">
                    <div class="spinner-border me-2" role="status"></div>
                    <span>Ładowanie Twoich ustawień...</span>
                </div>
            }
            else
            {
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Dane profilu i firmy</h5>
                    </div>
                    <div class="card-body p-4">
                        <ValidatedEditForm TModel="UpdateUserDto" Model="userModel" OnValidSubmit="HandleValidSubmit">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <ValidatedInputText @bind-Value="userModel.Name"
                                                        Label="Imię i Nazwisko"
                                                        Placeholder="Wpisz imię i nazwisko" />
                                </div>

                                <div class="col-md-6">
                                    <ValidatedInputText @bind-Value="userModel.CompanyName"
                                                        Label="Pełna Nazwa Firmy"
                                                        Placeholder="Wpisz nazwę firmy" />
                                </div>

                                <div class="col-md-6">
                                    <ValidatedInputText @bind-Value="userModel.Email"
                                                        Label="Email"
                                                        Placeholder="adres@example.com" Type="email" />
                                </div>

                                <div class="col-md-6">
                                    <ValidatedInputText @bind-Value="userModel.Nip"
                                                        Label="NIP"
                                                        Placeholder="1234567890" />
                                </div>

                                <div class="col-md-12">
                                    <ValidatedInputText @bind-Value="userModel.BankAccountNumber"
                                                        Label="Numer konta bankowego"
                                                        Placeholder="PL..." />
                                </div>

                                <div class="col-12">
                                    <hr class="my-4" />
                                    <h5 class="text-secondary mb-3">Adres siedziby</h5>
                                </div>

                                <div class="col-md-9">
                                    <ValidatedInputText @bind-Value="userModel.Address.Street"
                                                        Label="Ulica"
                                                        Placeholder="Ulica" />
                                </div>
                                <div class="col-md-3">
                                    <ValidatedInputText @bind-Value="userModel.Address.Number"
                                                        Label="Nr budynku"
                                                        Placeholder="Nr" />
                                </div>
                                <div class="col-md-4">
                                    <ValidatedInputText @bind-Value="userModel.Address.PostalCode"
                                                        Label="Kod pocztowy"
                                                        Placeholder="12-345" />
                                </div>
                                <div class="col-md-8">
                                    <ValidatedInputText @bind-Value="userModel.Address.City"
                                                        Label="Miasto"
                                                        Placeholder="Miasto" />
                                </div>
                                <div class="col-md-12">
                                    <ValidatedInputText @bind-Value="userModel.Address.Country"
                                                        Label="Kraj"
                                                        Placeholder="Kraj" />
                                </div>
                            </div>

                            <div class="mt-4 d-flex align-items-center">
                                <button type="submit" class="btn btn-success px-4" disabled="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    Zapisz zmiany
                                </button>
                                @if (!string.IsNullOrEmpty(statusMessage))
                                {
                                    <span class="ms-3 alert @statusClass p-2 mb-0">@statusMessage</span>
                                }
                            </div>
                        </ValidatedEditForm>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <h5>Bezpieczeństwo</h5>
                        <p class="text-muted small">Zalecamy regularną zmianę hasła dla ochrony Twoich danych fakturowych.</p>
                        <a href="/change-password" class="btn btn-outline-warning">
                            <i class="bi bi-shield-lock"></i> Zmień hasło dostępu
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private UpdateUserDto? userModel;
    private bool isSubmitting = false;
    private string statusMessage = "";
    private string statusClass = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<GetMeResponse>("api/User/me");

            if (response?.Data != null)
            {
                var userData = response.Data;
                userModel = new UpdateUserDto
                {
                    UserId = userData.UserId,
                    Name = userData.Name,
                    CompanyName = userData.CompanyName,
                    Email = userData.Email,
                    Nip = userData.Nip,
                    BankAccountNumber = userData.BankAccountNumber,
                    Address = new UpdateAddressDto
                    {
                        Street = userData.Address.Street,
                        Number = userData.Address.Number,
                        PostalCode = userData.Address.PostalCode,
                        City = userData.Address.City,
                        Country = userData.Address.Country
                    }
                };
            }
        }
        catch (Exception)
        {
            statusMessage = "Błąd autoryzacji sesji.";
            statusClass = "alert-danger";
            userModel = new UpdateUserDto();
        }
    }

    private async Task HandleValidSubmit()
    {
        if (userModel == null) return;
        isSubmitting = true;
        statusMessage = "";
        statusClass = "";

        try
        {
            var response = await Http.PutAsJsonAsync($"api/User/update/{userModel.UserId}", userModel);
            if (response.IsSuccessStatusCode)
            {
                statusMessage = "Ustawienia zapisane!";
                statusClass = "alert-success";
            }
            else
            {
                string serverMsg = await response.Content.ReadAsStringAsync();
                statusMessage = string.IsNullOrWhiteSpace(serverMsg) ? "Błąd podczas zapisu na serwerze." : serverMsg;
                statusClass = "alert-danger";
            }
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class UpdateUserDto
    {
        public int UserId { get; set; }

        [Required(ErrorMessage = "Imię i nazwisko jest wymagane.")]
        [StringLength(100, ErrorMessage = "Maksymalnie 100 znaków.")]
        public string Name { get; set; } = string.Empty;

        [Required(ErrorMessage = "Nazwa firmy jest wymagana.")]
        [StringLength(200, ErrorMessage = "Maksymalnie 200 znaków.")]
        public string CompanyName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Email jest wymagany.")]
        [EmailAddress(ErrorMessage = "Nieprawidłowy format email.")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "NIP jest wymagany.")]
        [RegularExpression(@"^\d{10}$", ErrorMessage = "NIP musi zawierać 10 cyfr.")]
        public string Nip { get; set; } = string.Empty;

        [Required(ErrorMessage = "Numer konta jest wymagany.")]
        [StringLength(34, MinimumLength = 16, ErrorMessage = "Numer konta musi mieć od 16 do 34 znaków.")]
        public string BankAccountNumber { get; set; } = string.Empty;

        public UpdateAddressDto Address { get; set; } = new();
    }

    public class UpdateAddressDto
    {
        [Required(ErrorMessage = "Ulica jest wymagana.")]
        public string Street { get; set; } = string.Empty;

        [Required(ErrorMessage = "Nr budynku jest wymagany.")]
        public string Number { get; set; } = string.Empty;

        [Required(ErrorMessage = "Kod pocztowy jest wymagany.")]
        [RegularExpression(@"^\d{2}-\d{3}$", ErrorMessage = "Kod pocztowy musi mieć format XX-XXX.")]
        public string PostalCode { get; set; } = string.Empty;

        [Required(ErrorMessage = "Miasto jest wymagane.")]
        public string City { get; set; } = string.Empty;

        [Required(ErrorMessage = "Kraj jest wymagany.")]
        public string Country { get; set; } = "Poland";
    }

    public class GetMeResponse
    {
        public UserDtoData? Data { get; set; }
    }

    public class UserDtoData
    {
        public int UserId { get; set; }
        public string Name { get; set; } = "";
        public string CompanyName { get; set; } = "";
        public string Email { get; set; } = "";
        public string Nip { get; set; } = "";
        public string BankAccountNumber { get; set; } = "";
        public UpdateAddressDto Address { get; set; } = new();
    }
}