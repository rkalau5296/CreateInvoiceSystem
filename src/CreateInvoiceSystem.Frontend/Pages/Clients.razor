@page "/clients"
@using CreateInvoiceSystem.Frontend.Models
@using CreateInvoiceSystem.Frontend.Services
@using System.ComponentModel.DataAnnotations
@using System.Linq.Expressions
@inject ClientService ClientService

<div class="container-fluid">
    <h3 class="mb-4">Kontrahenci</h3>

    <div class="row mb-4 align-items-end">
        <div class="col-md-6">
            <label class="form-label small fw-bold">Wyszukaj kontrahenta</label>
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input type="text"
                       class="form-control border-start-0"
                       placeholder="Szukaj po nazwie lub NIP..."
                       @bind="_searchTerm"
                       @bind:event="oninput"
                       @onkeyup="HandleSearch" />
                @if (!string.IsNullOrWhiteSpace(_searchTerm))
                {
                    <button class="btn btn-outline-secondary border-start-0" @onclick="ClearSearch">
                        <i class="bi bi-x-lg"></i>
                    </button>
                }
            </div>
        </div>

        <div class="col-md-6 text-end">
            <button class="btn btn-outline-secondary me-2" @onclick="ExportToCsv">
                <i class="bi bi-file-earmark-spreadsheet me-1"></i> Eksportuj CSV
            </button>
            <button class="btn btn-primary" @onclick="OpenAddModal">
                <i class="bi bi-person-plus-fill me-1"></i> Dodaj klienta
            </button>
        </div>
    </div>

    @if (_isModalOpen)
    {
        <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog modal-lg shadow-lg">
                <div class="modal-content">
                    <ValidatedEditForm TModel="ClientDto" Model="_editingClient" OnValidSubmit="HandleSubmit" OnInvalidSubmit="HandleInvalidSubmit">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">@(_isEditMode ? "Edytuj Kontrahenta" : "Nowy Kontrahent")</h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                        </div>

                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">Nazwa firmy <span class="text-danger">*</span></label>
                                    <ValidatedInputText @bind-Value="_editingClient.Name" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">NIP <span class="text-danger">*</span></label>
                                    <ValidatedInputText @bind-Value="_editingClient.Nip" />
                                </div>

                                <hr class="my-2 text-muted" />
                                <h6 class="text-muted mb-2">Adres kontrahenta</h6>

                                <div class="col-md-9">
                                    <label class="form-label fw-bold">Ulica <span class="text-danger">*</span></label>
                                    <ValidatedInputText @bind-Value="_editingClient.Address.Street" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Numer <span class="text-danger">*</span></label>
                                    <ValidatedInputText @bind-Value="_editingClient.Address.Number" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Kod pocztowy <span class="text-danger">*</span></label>
                                    <ValidatedInputText @bind-Value="_editingClient.Address.PostalCode" />
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">Miasto <span class="text-danger">*</span></label>
                                    <ValidatedInputText @bind-Value="_editingClient.Address.City" />
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">Anuluj</button>
                            <button type="submit" class="btn btn-success px-4">
                                <i class="bi bi-check-circle me-1"></i> Zapisz
                            </button>
                        </div>
                    </ValidatedEditForm>
                </div>
            </div>
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-header bg-light">Twoja lista kontrahentów</div>
        <div class="card-body p-0">
            <DataTable Items="_clients" Cols="4" TableClass="table table-hover mb-0" HeaderClass="table-dark" KeySelector="c => c.ClientId" NoItemsMessage="Brak kontrahentów w bazie.">
                <HeaderTemplate>
                    <tr>
                        <th>Nazwa</th>
                        <th>NIP</th>
                        <th>Adres</th>
                        <th class="text-center">Akcje</th>
                    </tr>
                </HeaderTemplate>

                <RowTemplate Context="c">
                    <td class="align-middle"><strong>@c.Name</strong></td>
                    <td class="align-middle">@c.Nip</td>
                    <td class="align-middle small">
                        @if (c.Address != null)
                        {
                            <span>@c.Address.Street @c.Address.Number, @c.Address.PostalCode @c.Address.City</span>
                        }
                        else
                        {
                            <span class="text-muted">Brak adresu</span>
                        }
                    </td>
                    <td class="text-center align-middle">
                        <div class="d-flex justify-content-center gap-2">
                            <button class="btn btn-sm btn-primary px-3 shadow-sm" @onclick="() => OpenEditModal(c)">
                                <i class="bi bi-pencil-square me-1"></i> Edytuj
                            </button>
                            <button class="btn btn-sm btn-danger px-3 shadow-sm" @onclick="() => HandleDelete(c.ClientId)">
                                <i class="bi bi-trash me-1"></i> Usuń
                            </button>
                        </div>
                    </td>
                </RowTemplate>
            </DataTable>
        </div>
    </div>
</div>

<Pagination ItemsOnPageCount="@(_clients?.Count ?? 0)"
            TotalItems="@_totalCount"
            CurrentPage="@_currentPage"
            CurrentPageChanged="ChangePage"
            PageSize="@_page_size"
            PageSizeChanged="ChangePageSize"
            ItemLabel="klientów" />

@code {
    private List<ClientDto>? _clients;
    private ClientDto _editingClient = new() { Address = new AddressDto() };
    private string _searchTerm = "";
    private int _currentPage = 1;
    private int _page_size = 10;
    private int _pageSize { get => _page_size; set => _page_size = value; }
    private int _totalCount = 0;
    private int _totalPages => (_pageSize == 0) ? 0 : (int)Math.Ceiling((double)_totalCount / _pageSize);
    private bool _isModalOpen = false;
    private bool _isEditMode = false;
    private System.Timers.Timer? _searchTimer;

    private bool _submitAttempted = false;
    private HashSet<string> _invalidFields = new();

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        var response = await ClientService.GetClientsAsync(_currentPage, _pageSize, _searchTerm);
        _clients = response.Data;
        _totalCount = response.TotalCount;

        if (_clients != null)
        {
            foreach (var client in _clients.Where(c => c.Address == null))
            {
                client.Address = new AddressDto();
            }
        }

        StateHasChanged();
    }

    private void HandleSearch()
    {
        _searchTimer?.Stop();
        _searchTimer?.Dispose();
        _searchTimer = new System.Timers.Timer(400);
        _searchTimer.Elapsed += async (s, e) =>
        {
            _searchTimer.Stop();
            _currentPage = 1;
            await InvokeAsync(LoadData);
        };
        _searchTimer.Start();
    }

    private async Task ClearSearch()
    {
        _searchTerm = "";
        _currentPage = 1;
        await LoadData();
    }

    private async Task ChangePage(int newPage)
    {
        if (newPage < 1) return;
        _currentPage = newPage;
        await LoadData();
    }

    private async Task ChangePageSize(int newSize)
    {
        if (newSize <= 0) return;
        _pageSize = newSize;
        _currentPage = 1;
        await LoadData();
    }

    private void OpenAddModal()
    {
        _isEditMode = false;
        _editingClient = new ClientDto { Address = new AddressDto() };
        _invalidFields.Clear();
        _submitAttempted = false;
        _isModalOpen = true;
    }

    private void OpenEditModal(ClientDto client)
    {
        _isEditMode = true;
        _editingClient = new ClientDto
        {
            ClientId = client.ClientId,
            Name = client.Name,
            Nip = client.Nip,
            UserId = client.UserId,
            AddressId = client.Address?.AddressId ?? 0,
            Address = new AddressDto
            {
                AddressId = client.Address?.AddressId ?? 0,
                Street = client.Address?.Street ?? "",
                Number = client.Address?.Number ?? "",
                City = client.Address?.City ?? "",
                PostalCode = client.Address?.PostalCode ?? "",
                Country = client.Address?.Country ?? "Polska"
            }
        };
        _invalidFields.Clear();
        _submitAttempted = false;
        _isModalOpen = true;
    }

    private void CloseModal() => _isModalOpen = false;

    private void HandleInvalidSubmit()
    {
        _submitAttempted = true;
        RunValidationAndCollectInvalidFields();
    }

    private Task HandleInvalidSubmit(EditContext ctx)
    {
        HandleInvalidSubmit();
        return Task.CompletedTask;
    }

    private async Task HandleSubmit()
    {
        _submitAttempted = true;
        RunValidationAndCollectInvalidFields();

        if (!_invalid_fields_any())
        {
            await HandleSave();
        }
    }

    private bool _invalid_fields_any() => _invalidFields.Any();

    private void RunValidationAndCollectInvalidFields()
    {
        _invalidFields.Clear();

        var context = new ValidationContext(_editingClient);
        var results = new List<ValidationResult>();
        Validator.TryValidateObject(_editingClient, context, results, true);
        foreach (var r in results)
        {
            foreach (var m in r.MemberNames)
            {
                if (!string.IsNullOrWhiteSpace(m))
                    _invalidFields.Add(m);
            }
        }

        if (_editingClient.Address != null)
        {
            var addrCtx = new ValidationContext(_editingClient.Address);
            var addrResults = new List<ValidationResult>();
            Validator.TryValidateObject(_editingClient.Address, addrCtx, addrResults, true);
            foreach (var r in addrResults)
            {
                foreach (var m in r.MemberNames)
                {
                    if (!string.IsNullOrWhiteSpace(m))
                        AddInvalid($"Address.{m}");
                }
            }
        }

        if (_editingClient.Address == null)
        {
            AddInvalid("Address");
        }
        else
        {
            if (string.IsNullOrWhiteSpace(_editingClient.Address.Street))
                AddInvalid("Address.Street");
            if (string.IsNullOrWhiteSpace(_editingClient.Address.Number))
                AddInvalid("Address.Number");
            if (string.IsNullOrWhiteSpace(_editingClient.Address.PostalCode))
                AddInvalid("Address.PostalCode");
            if (string.IsNullOrWhiteSpace(_editingClient.Address.City))
                AddInvalid("Address.City");
        }
    }

    private void AddInvalid(string s) => _invalidFields.Add(s);

    private async Task HandleSave()
    {
        try
        {
            if (_isEditMode)
                await ClientService.UpdateClientAsync(_editingClient);
            else
                await ClientService.SaveClientAsync(_editingClient);

            _isModalOpen = false;
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Błąd: {ex.Message}");
        }
    }

    private async Task HandleDelete(int id)
    {
        try
        {
            await ClientService.DeleteClientAsync(id);
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Błąd: {ex.Message}");
        }
    }

    private async Task ExportToCsv() => await ClientService.DownloadClientsCsvAsync();

    private string GetFieldClass<T>(Expression<Func<T>> accessor)
    {
        if (!_submitAttempted) return "";

        var path = GetPropertyPath(accessor);

        if (_invalidFields.Contains(path)) return "is-invalid";

        T? value;
        try
        {
            value = accessor.Compile().Invoke();
        }
        catch
        {
            value = default;
        }

        bool hasValue;
        if (value is string s)
            hasValue = !string.IsNullOrWhiteSpace(s);
        else
            hasValue = !EqualityComparer<T?>.Default.Equals(value, default);

        return hasValue ? "is-valid" : "is-invalid";
    }

    private static string GetPropertyPath<T>(Expression<Func<T>> expr)
    {
        var parts = new List<string>();
        Expression e = expr.Body;
        while (e is MemberExpression me)
        {
            parts.Insert(0, me.Member.Name);
            e = me.Expression!;
        }
        return string.Join(".", parts);
    }
}