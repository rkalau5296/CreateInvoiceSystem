@page "/nbp-rates"
@using System.Text.Json
@using CreateInvoiceSystem.Frontend.Services
@using CreateInvoiceSystem.Frontend.Models
@inject NbpService NbpService

<div class="container mt-4">
    <div class="card shadow-sm border-0 bg-light">
        <div class="card-body">
            <h5 class="card-title mb-4"><i class="bi bi-filter-square me-2"></i>Filtry wyszukiwania</h5>
            <div class="row g-3">
                <div class="col-md-2">
                    <label class="form-label small fw-bold">Tabela</label>
                    <select class="form-select" @bind="_selectedTable" disabled="@_isLoading">
                        <option value="A">A (Średnie)</option>
                        <option value="B">B (Rzadkie)</option>
                        <option value="C">C (Kupno/Sprzedaż)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold">Kod waluty (opcjonalnie)</label>
                    <input type="text" class="form-control" placeholder="np. USD" @bind="_currencyCode" maxlength="3" disabled="@_isLoading" />
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Data od</label>
                    <input type="date" class="form-control" @bind="_dateFrom" disabled="@_isLoading" />
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Data do</label>
                    <input type="date" class="form-control" @bind="_dateTo" disabled="@_isLoading" />
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" @onclick="ExecuteSearch" disabled="@_isLoading">
                        <i class="bi bi-search me-1"></i> Szukaj
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(_statusMessage))
    {
        <div class="mt-3">
            <div class="alert @( _isError ? "alert-danger" : "alert-info")">
                @_statusMessage
            </div>
        </div>
    }

    @if (_isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Łączenie z Twoim API NBP...</p>
        </div>
    }
    else if (_allTables != null && _allTables.Any())
    {
        <div class="mt-4">
            <div class="alert alert-info py-2">
                Wyniki dla: <strong>@_selectedTable</strong>
                @(!string.IsNullOrEmpty(_currencyCode) ? $" | Waluta: {_currencyCode.ToUpper()}" : "")
                | Zakres: @_dateFrom.ToShortDateString() - @_dateTo.ToShortDateString()
                | Znaleziono dni: @_allTables.Count
            </div>

            @foreach (var table in _allTables)
            {
                <div class="card mb-3 border">
                    <div class="card-header bg-dark text-white d-flex justify-content-between py-1">
                        <span>Tabela: @table.Table</span>
                        <span>Data publikacji: @(string.IsNullOrEmpty(table.EffectiveDate) ? "Brak daty" : table.EffectiveDate)</span>
                    </div>
                    <table class="table table-hover mb-0 bg-white">
                        <thead class="table-light">
                            <tr>
                                <th>Waluta</th>
                                <th>Kod</th>
                                <th class="text-end">Kurs (Mid)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var rate in table.Rates ?? new())
                            {
                                <tr>
                                    <td>@(string.IsNullOrEmpty(rate.Currency) ? table.Currency : rate.Currency)</td>
                                    <td><span class="badge bg-secondary">@(string.IsNullOrEmpty(rate.Code) ? table.Code : rate.Code)</span></td>
                                    <td class="text-end fw-bold">@rate.Mid.ToString("F4")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
</div>

@code {
    private string _selectedTable = "A";
    private string _currencyCode = "";
    private DateTime _dateFrom = DateTime.Today;
    private DateTime _dateTo = DateTime.Today;

    private List<CurrencyRatesTable> _allTables = new();
    private bool _isLoading = false;

    private string _statusMessage = "";
    private bool _isError = false;

    private async Task ExecuteSearch()
    {
        _isLoading = true;
        _allTables.Clear();
        _statusMessage = "";
        _isError = false;

        if (_dateFrom > _dateTo)
        {
            _statusMessage = "Data 'od' nie może być późniejsza niż data 'do'.";
            _isError = true;
            _isLoading = false;
            return;
        }

        bool isSpecificCurrency = !string.IsNullOrWhiteSpace(_currencyCode);
        bool isDateRange = _dateFrom != _dateTo;

        try
        {
            if (isSpecificCurrency)
            {
                CurrencyRatesTable? result;
                if (isDateRange)
                    result = await NbpService.GetSpecificCurrencyHistoryAsync(_selectedTable, _currencyCode, _dateFrom, _dateTo);
                else
                    result = await NbpService.GetSpecificCurrencyRateAsync(_selectedTable, _currencyCode);

                if (result != null) _allTables.Add(result);
                else
                {
                    _statusMessage = "Brak danych dla podanych parametrów.";
                    _isError = true;
                }
            }
            else
            {
                if (isDateRange)
                {
                    var list = await NbpService.GetTableHistoryAsync(_selectedTable, _dateFrom, _dateTo);
                    if (list != null && list.Any())
                        _allTables = list;
                    else
                    {
                        _statusMessage = "Brak danych w podanym zakresie dat.";
                        _isError = true;
                    }
                }
                else
                {
                    var result = await NbpService.GetCurrentTableAsync(_selectedTable);
                    if (result != null) _allTables.Add(result);
                    else
                    {
                        _statusMessage = "Brak danych dla bieżącej daty.";
                        _isError = true;
                    }
                }
            }
        }
        catch (ApiException aex)
        {
            _statusMessage = aex.GetUserMessage();
            _isError = true;

            if (!string.IsNullOrWhiteSpace(aex.Response))
            {
                try
                {
                    using var doc = JsonDocument.Parse(aex.Response);
                    if (doc.RootElement.TryGetProperty("errors", out var errorsElement) && errorsElement.ValueKind == JsonValueKind.Object)
                    {
                        var sb = new System.Text.StringBuilder();
                        foreach (var prop in errorsElement.EnumerateObject())
                        {
                            foreach (var msgElem in prop.Value.EnumerateArray())
                            {
                                var msg = msgElem.GetString();
                                if (!string.IsNullOrWhiteSpace(msg))
                                {
                                    if (sb.Length > 0) sb.Append(" ; ");
                                    sb.Append(msg);
                                }
                            }
                        }
                        if (sb.Length > 0)
                        {
                            _statusMessage = sb.ToString();
                        }
                    }
                }
                catch
                {
                }
            }
        }
        catch (Exception ex)
        {
            _statusMessage = $"Nieoczekiwany błąd: {ex.Message}";
            _isError = true;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}