@page "/change-password"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using CreateInvoiceSystem.Frontend.Components
@inject HttpClient Http

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-5">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0 text-center">Zmiana hasła</h5>
                </div>
                <div class="card-body p-4">
                    <ValidatedEditForm TModel="FormModel" Model="formData" OnValidSubmit="OnSubmit">
                        <div class="mb-3">
                            <ValidatedInputText @bind-Value="formData.OldPassword"
                                                Label="Obecne hasło"
                                                Placeholder="Wprowadź obecne hasło"
                                                Type="password" />
                        </div>

                        <div class="mb-3">
                            <ValidatedInputText @bind-Value="formData.NewPassword"
                                                Label="Nowe hasło"
                                                Placeholder="Wprowadź nowe hasło"
                                                Type="password" />
                        </div>

                        <div class="mb-4">
                            <ValidatedInputText @bind-Value="formData.ConfirmPassword"
                                                Label="Potwierdź nowe hasło"
                                                Placeholder="Powtórz nowe hasło"
                                                Type="password" />
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    <span class="ms-2">Przetwarzanie...</span>
                                }
                                else
                                {
                                    <span>Zapisz zmiany</span>
                                }
                            </button>
                            <a href="/settings" class="btn btn-link text-center text-decoration-none small text-secondary">Wróć do ustawień</a>
                        </div>
                    </ValidatedEditForm>

                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert mt-4 py-2 small @(isError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
                            @message
                            <button type="button" class="btn-close" @onclick="() => message = string.Empty"></button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private FormModel formData = new();
    private string message = "";
    private bool isError = false;
    private bool isSubmitting = false;

    private async Task OnSubmit()
    {
        isSubmitting = true;
        message = "";
        isError = false;

        var dto = new ChangePasswordDto(formData.OldPassword, formData.NewPassword, formData.ConfirmPassword);
        var request = new ChangePasswordRequest(dto);

        try
        {
            var response = await Http.PostAsJsonAsync("api/Auth/change-password", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ChangePasswordResponse>();

                if (result != null && result.IsSuccess)
                {
                    message = "Hasło zostało pomyślnie zmienione.";
                    isError = false;

                    formData = new FormModel();
                    StateHasChanged();
                }
                else
                {
                    message = result?.Message ?? "Wystąpił błąd podczas zmiany hasła.";
                    isError = true;
                }
            }
            else
            {
                var serverMsg = await response.Content.ReadAsStringAsync();
                message = string.IsNullOrWhiteSpace(serverMsg) ? $"Błąd serwera: {response.StatusCode}" : serverMsg;
                isError = true;
            }
        }
        catch (Exception ex)
        {
            message = $"Wystąpił nieoczekiwany błąd: {ex.Message}";
            isError = true;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    public record ChangePasswordDto(string OldPassword, string NewPassword, string ConfirmPassword);
    public record ChangePasswordRequest(ChangePasswordDto dto);
    public record ChangePasswordResponse(bool IsSuccess, string Message);

    public class FormModel
    {
        [Required(ErrorMessage = "Podaj stare hasło")]
        public string OldPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Podaj nowe hasło")]
        [MinLength(6, ErrorMessage = "Hasło musi mieć min. 6 znaków")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Powtórz nowe hasło")]
        [Compare(nameof(NewPassword), ErrorMessage = "Hasła nie są identyczne!")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}