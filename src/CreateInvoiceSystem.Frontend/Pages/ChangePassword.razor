@page "/change-password"
@using CreateInvoiceSystem.Frontend.Models
@using System.ComponentModel.DataAnnotations
@inject HttpClient Http

<div class="row justify-content-center mt-5">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Zmiana hasła</h5>
            </div>
            <div class="card-body">
                <EditForm Model="formData" OnValidSubmit="OnSubmit">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <label class="form-label">Obecne hasło</label>
                        <InputText @bind-Value="formData.OldPassword" type="password" class="form-control" placeholder="Wprowadź obecne hasło" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Nowe hasło</label>
                        <InputText @bind-Value="formData.NewPassword" type="password" class="form-control" placeholder="Wprowadź nowe hasło" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Potwierdź nowe hasło</label>
                        <InputText @bind-Value="formData.ConfirmPassword" type="password" class="form-control" placeholder="Powtórz nowe hasło" />
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span class="ms-2">Przetwarzanie...</span>
                            }
                            else
                            {
                                <span>Zapisz zmiany</span>
                            }
                        </button>
                    </div>
                </EditForm>

                @if (!string.IsNullOrEmpty(message))
                {
                    <div class="alert mt-3 @(isError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
                        @message
                        <button type="button" class="btn-close" @onclick="() => message = string.Empty"></button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {    
    private FormModel formData = new();

    private string message = "";
    private bool isError = false;
    private bool isSubmitting = false;

    private async Task OnSubmit()
    {
        if (formData.NewPassword != formData.ConfirmPassword)
        {
            message = "Nowe hasło i potwierdzenie muszą być identyczne.";
            isError = true;
            return; 
        }

        isSubmitting = true;
        message = "";
        
        var dto = new ChangePasswordDto(formData.OldPassword, formData.NewPassword, formData.ConfirmPassword);
        
        var request = new ChangePasswordRequest(dto);

        try
        {            
            var response = await Http.PostAsJsonAsync("api/Auth/change-password", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ChangePasswordResponse>();

                if (result != null && result.IsSuccess)
                {
                    message = "Hasło zostało pomyślnie zmienione.";
                    isError = false;
                    formData = new FormModel(); 
                }
                else
                {
                    message = result?.Message ?? "Wystąpił błąd podczas zmiany hasła.";
                    isError = true;
                }
            }
            else
            {
                message = $"Błąd serwera: {response.StatusCode}";
                isError = true;
            }
        }
        catch (Exception ex)
        {
            message = $"Wystąpił nieoczekiwany błąd: {ex.Message}";
            isError = true;
        }
        finally
        {
            isSubmitting = false;
        }
    }
    
    public class FormModel
    {
        [Required(ErrorMessage = "Podaj stare hasło")]
        public string OldPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Podaj nowe hasło")]
        [MinLength(6, ErrorMessage = "Hasło musi mieć min. 6 znaków")]
        public string NewPassword { get; set; } = string.Empty;

        [Compare(nameof(NewPassword), ErrorMessage = "Hasła nie są identyczne!")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}