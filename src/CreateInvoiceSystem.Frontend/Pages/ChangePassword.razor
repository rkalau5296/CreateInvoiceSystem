@page "/change-password"
@using System.ComponentModel.DataAnnotations
@using System.Linq.Expressions
@using System.Reflection
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http

<div class="row justify-content-center mt-5">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Zmiana hasła</h5>
            </div>
            <div class="card-body">
                <EditForm EditContext="@editContext" OnValidSubmit="OnSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger" />

                    <div class="mb-3">
                        <label class="form-label">
                            Obecne hasło
                            @if (IsRequired(() => formData.OldPassword))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText @bind-Value="formData.OldPassword" type="password" class="form-control" placeholder="Wprowadź obecne hasło" />
                        <ValidationMessage For="@(() => formData.OldPassword)" class="invalid-feedback" />
                        @if (IsFieldModified(() => formData.OldPassword) && !GetValidationMessages(() => formData.OldPassword).Any())
                        {
                            <div class="valid-feedback d-block">Wygląda dobrze.</div>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            Nowe hasło
                            @if (IsRequired(() => formData.NewPassword))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText @bind-Value="formData.NewPassword" type="password" class="form-control" placeholder="Wprowadź nowe hasło" />
                        <ValidationMessage For="@(() => formData.NewPassword)" class="invalid-feedback" />
                        @if (IsFieldModified(() => formData.NewPassword) && !GetValidationMessages(() => formData.NewPassword).Any())
                        {
                            <div class="valid-feedback d-block">Hasło spełnia wymagania.</div>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            Potwierdź nowe hasło
                            @if (IsRequired(() => formData.ConfirmPassword))
                            {
                                <span class="text-danger ms-1" title="Pole wymagane">*</span>
                            }
                        </label>
                        <InputText @bind-Value="formData.ConfirmPassword" type="password" class="form-control" placeholder="Powtórz nowe hasło" />
                        <ValidationMessage For="@(() => formData.ConfirmPassword)" class="invalid-feedback" />
                        @if (IsFieldModified(() => formData.ConfirmPassword) && !GetValidationMessages(() => formData.ConfirmPassword).Any())
                        {
                            <div class="valid-feedback d-block">Hasła się zgadzają.</div>
                        }
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span class="ms-2">Przetwarzanie...</span>
                            }
                            else
                            {
                                <span>Zapisz zmiany</span>
                            }
                        </button>
                    </div>
                </EditForm>

                @if (!string.IsNullOrEmpty(message))
                {
                    <div class="alert mt-3 @(isError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
                        @message
                        <button type="button" class="btn-close" @onclick="() => message = string.Empty"></button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private FormModel formData = new();
    private EditContext? editContext;

    private string message = "";
    private bool isError = false;
    private bool isSubmitting = false;

    protected override void OnInitialized()
    {
        editContext = new EditContext(formData);
        editContext.SetFieldCssClassProvider(new BootstrapValidationClassProvider());
    }

    private async Task OnSubmit()
    {        
        if (editContext == null) return;
        var isValid = editContext.Validate();

        if (!isValid)
        {
            message = "Proszę poprawić błędy w formularzu.";
            isError = true;
            return;
        }

        if (formData.NewPassword != formData.ConfirmPassword)
        {
            message = "Nowe hasło i potwierdzenie muszą być identyczne.";
            isError = true;
            return;
        }

        isSubmitting = true;
        message = "";

        var dto = new ChangePasswordDto(formData.OldPassword, formData.NewPassword, formData.ConfirmPassword);
        var request = new ChangePasswordRequest(dto);

        try
        {
            var response = await Http.PostAsJsonAsync("api/Auth/change-password", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ChangePasswordResponse>();

                if (result != null && result.IsSuccess)
                {
                    message = "Hasło zostało pomyślnie zmienione.";
                    isError = false;
                    
                    formData = new FormModel();
                    editContext = new EditContext(formData);
                    editContext.SetFieldCssClassProvider(new BootstrapValidationClassProvider());
                }
                else
                {
                    message = result?.Message ?? "Wystąpił błąd podczas zmiany hasła.";
                    isError = true;
                }
            }
            else
            {
                message = $"Błąd serwera: {response.StatusCode}";
                isError = true;
            }
        }
        catch (Exception ex)
        {
            message = $"Wystąpił nieoczekiwany błąd: {ex.Message}";
            isError = true;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
    
    private IEnumerable<string> GetValidationMessages<T>(Expression<Func<T>> accessor)
    {
        if (editContext == null) return Enumerable.Empty<string>();
        var field = FieldIdentifier.Create(accessor);
        return editContext.GetValidationMessages(field);
    }

    private bool IsFieldModified<T>(Expression<Func<T>> accessor)
    {
        if (editContext == null) return false;
        var field = FieldIdentifier.Create(accessor);
        return editContext.IsModified(field);
    }

    private bool IsRequired<T>(Expression<Func<T>> accessor)
    {
        MemberExpression? member = accessor.Body as MemberExpression;
        if (member == null && accessor.Body is UnaryExpression ue && ue.Operand is MemberExpression me)
        {
            member = me;
        }

        if (member == null) return false;

        if (member.Member is PropertyInfo prop)
        {
            if (Attribute.IsDefined(prop, typeof(RequiredAttribute))) return true;
            var getMethod = prop.GetGetMethod(true);
            if (getMethod != null && Attribute.IsDefined(getMethod, typeof(RequiredAttribute))) return true;
        }

        return false;
    }
    
    public record ChangePasswordDto(string OldPassword, string NewPassword, string ConfirmPassword);
    public record ChangePasswordRequest(ChangePasswordDto Data);
    public record ChangePasswordResponse(bool IsSuccess, string Message);
        
    public class FormModel
    {
        [Required(ErrorMessage = "Podaj stare hasło")]
        public string OldPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Podaj nowe hasło")]
        [MinLength(6, ErrorMessage = "Hasło musi mieć min. 6 znaków")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Powtórz nowe hasło")]
        [Compare(nameof(NewPassword), ErrorMessage = "Hasła nie są identyczne!")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
    
    public class BootstrapValidationClassProvider : FieldCssClassProvider
    {
        public override string GetFieldCssClass(EditContext editContext, in FieldIdentifier fieldIdentifier)
        {
            var hasErrors = editContext.GetValidationMessages(fieldIdentifier).Any();
            if (!editContext.IsModified(fieldIdentifier))
            {
                return string.Empty;
            }
            return hasErrors ? "is-invalid" : "is-valid";
        }
    }
}