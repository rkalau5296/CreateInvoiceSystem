@page "/register"
@using CreateInvoiceSystem.Frontend.Models
@attribute [AllowAnonymous]
@inject HttpClient Http
@inject NavigationManager Navigation

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white py-3">
                    <h3 class="mb-0">Rejestracja konta firmowego</h3>
                </div>
                <div class="card-body p-4">
                    <EditForm Model="regModel" OnValidSubmit="HandleRegister">
                        <DataAnnotationsValidator />

                        <div class="row">
                            <div class="col-md-6 border-end">
                                <h5 class="text-primary mb-3">Dane użytkownika</h5>
                                <div class="mb-3">
                                    <label class="form-label">Email / Login</label>
                                    <InputText @bind-Value="regModel.Email" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Hasło</label>
                                    <InputText @bind-Value="regModel.Password" type="password" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Imię i Nazwisko</label>
                                    <InputText @bind-Value="regModel.Name" class="form-control" />
                                </div>

                                <h5 class="text-primary mt-4 mb-3">Dane firmy</h5>
                                <div class="mb-3">
                                    <label class="form-label">Nazwa firmy</label>
                                    <InputText @bind-Value="regModel.CompanyName" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">NIP</label>
                                    <InputText @bind-Value="regModel.Nip" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Konto bankowe</label>
                                    <InputText @bind-Value="regModel.BankAccountNumber" class="form-control" />
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5 class="text-primary mb-3">Adres siedziby</h5>
                                <div class="mb-3">
                                    <label class="form-label">Ulica</label>
                                    <InputText @bind-Value="regModel.Address.Street" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Numer budynku</label>
                                    <InputText @bind-Value="regModel.Address.Number" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Kod pocztowy</label>
                                    <InputText @bind-Value="regModel.Address.PostalCode" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Miasto</label>
                                    <InputText @bind-Value="regModel.Address.City" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Kraj</label>
                                    <InputText @bind-Value="regModel.Address.Country" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Trwa rejestracja...</span>
                                }
                                else
                                {
                                    <span>Zarejestruj konto</span>
                                }
                            </button>
                            <a href="/" class="btn btn-link text-center">Powrót do logowania</a>
                        </div>
                    </EditForm>

                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <div class="alert mt-4 @(isError ? "alert-danger" : "alert-success")">
                            @statusMessage
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private RegisterUserDto regModel = new();
    private bool isSubmitting = false;
    private string statusMessage = "";
    private bool isError = false;

    private async Task HandleRegister()
    {
        if (string.IsNullOrWhiteSpace(regModel.Email) || string.IsNullOrWhiteSpace(regModel.Password))
        {
            statusMessage = "Pola Email i Hasło nie mogą być puste.";
            isError = true;
            return;
        }

        isSubmitting = true;
        statusMessage = "";
        isError = false;

        var request = new RegisterUserRequest(regModel);

        try
        {
            var response = await Http.PostAsJsonAsync("api/Auth/register", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<RegisterUserResponse>();

                if (result != null && result.Success)
                {
                    statusMessage = "Konto zostało utworzone pomyślnie!";
                    await Task.Delay(2000);
                    Navigation.NavigateTo("/");
                }
                else
                {
                    statusMessage = result?.Message ?? "Wystąpił błąd.";
                    isError = true;
                }
            }
            else
            {
                statusMessage = "Błąd serwera. Sprawdź poprawność danych.";
                isError = true;
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Błąd: {ex.Message}";
            isError = true;
        }
        finally
        {
            isSubmitting = false;
        }
    }
}