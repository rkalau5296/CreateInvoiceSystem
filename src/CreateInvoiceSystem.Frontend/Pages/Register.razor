@page "/register"
@using System.Linq
@using System.Text.Json
@using CreateInvoiceSystem.Frontend.Models
@using CreateInvoiceSystem.Frontend.Components
@using CreateInvoiceSystem.Frontend.Services
@using Microsoft.AspNetCore.Components.Forms
@attribute [AllowAnonymous]
@inject AuthService AuthService
@inject NavigationManager Navigation

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white py-3">
                    <h3 class="mb-0">Rejestracja konta firmowego</h3>
                </div>
                <div class="card-body p-4">
                    @if (!_isRegistered)
                    {
                        <ValidatedEditForm TModel="RegisterUserDto" Model="_regModel" OnValidSubmit="HandleRegister" OnInvalidSubmit="HandleInvalidSubmit" @ref="formRef">
                            <div class="row">
                                <div class="col-md-6 border-end">
                                    <h5 class="text-primary mb-3">Dane użytkownika</h5>
                                    <ValidatedInputText @bind-Value="_regModel.Email" Label="Email / Login" Placeholder="Email / Login" />
                                    <ValidatedInputText @bind-Value="_regModel.Password" Label="Hasło" Placeholder="Hasło" Type="password" />
                                    <ValidatedInputText @bind-Value="_regModel.ConfirmPassword" Label="Potwierdź Hasło" Placeholder="Potwierdź Hasło" Type="password" />
                                    <ValidatedInputText @bind-Value="_regModel.Name" Label="Imię i Nazwisko" Placeholder="Imię i Nazwisko" />

                                    <h5 class="text-primary mt-4 mb-3">Dane firmy</h5>
                                    <ValidatedInputText @bind-Value="_regModel.CompanyName" Label="Nazwa firmy" Placeholder="Nazwa firmy" />
                                    <ValidatedInputText @bind-Value="_regModel.Nip" Label="NIP" Placeholder="NIP" />
                                    <ValidatedInputText @bind-Value="_regModel.BankAccountNumber" Label="Konto bankowe" Placeholder="Konto bankowe" />
                                </div>

                                <div class="col-md-6">
                                    <h5 class="text-primary mb-3">Adres siedziby</h5>
                                    <ValidatedInputText @bind-Value="_regModel.Address.Street" Label="Ulica" Placeholder="Ulica" />
                                    <ValidatedInputText @bind-Value="_regModel.Address.Number" Label="Numer budynku" Placeholder="Numer budynku" />
                                    <ValidatedInputText @bind-Value="_regModel.Address.PostalCode" Label="Kod pocztowy" Placeholder="Kod pocztowy" />
                                    <ValidatedInputText @bind-Value="_regModel.Address.City" Label="Miasto" Placeholder="Miasto" />
                                    <ValidatedInputText @bind-Value="_regModel.Address.Country" Label="Kraj" Placeholder="Kraj" />
                                </div>
                            </div>

                            <hr class="my-4" />

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" disabled="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        <span>Trwa rejestracja...</span>
                                    }
                                    else
                                    {
                                        <span>Zarejestruj konto</span>
                                    }
                                </button>
                                <a href="/" class="btn btn-link text-center">Powrót do logowania</a>
                            </div>
                        </ValidatedEditForm>

                        @if (!string.IsNullOrEmpty(statusMessage))
                        {
                            <div class="alert mt-4 @(isError ? "alert-danger" : "alert-success")">
                                @statusMessage
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center p-4">
                            <div class="mb-4">
                                <i class="bi bi-envelope-check text-success" style="font-size: 4rem;"></i>
                            </div>
                            <h3 class="text-success mb-3">Konto zostało utworzone!</h3>
                            <div class="alert alert-success shadow-sm">
                                <p class="mb-0">
                                    Jeśli podany adres e-mail jest prawidłowy, wysłaliśmy na niego <strong>link aktywacyjny</strong>.
                                    Prosimy o sprawdzenie skrzynki e-mail (oraz folderu Spam) i kliknięcie w link w celu aktywacji konta.
                                </p>
                            </div>
                            <div class="text-center mt-4">
                                <button type="button" class="btn btn-primary btn-lg w-100" @onclick='() => Navigation.NavigateTo("/")'>
                                    Przejdź do strony logowania
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private RegisterUserDto _regModel = new() { Address = new RegisterAddressDto() };
    private bool isSubmitting = false;
    private bool _isRegistered = false;
    private string statusMessage = "";
    private bool isError = false;

    private ValidatedEditForm<RegisterUserDto>? formRef;

    private void HandleInvalidSubmit(EditContext context)
    {
        statusMessage = "Uzupełnij wymagane pola.";
        isError = true;
    }

    private static string NormalizeFieldName(string original)
    {
        if (string.IsNullOrWhiteSpace(original))
            return original ?? string.Empty;

        var parts = original.Split(new[] { '.', '_', '/' }, StringSplitOptions.RemoveEmptyEntries);
        for (int i = 0; i < parts.Length; i++)
        {
            var p = parts[i];
            if (p.Length == 0) continue;
            parts[i] = char.ToUpperInvariant(p[0]) + (p.Length > 1 ? p.Substring(1) : string.Empty);
        }
        return string.Join('.', parts);
    }

    private async Task HandleRegister()
    {
        formRef?.ClearServerErrors();
        formRef?.EditContext?.NotifyValidationStateChanged();

        if (string.IsNullOrWhiteSpace(_regModel.Email)) formRef?.AddServerError(nameof(_regModel.Email), "Wymagane");
        if (string.IsNullOrWhiteSpace(_regModel.Password)) formRef?.AddServerError(nameof(_regModel.Password), "Wymagane");
        if (string.IsNullOrWhiteSpace(_regModel.Name)) formRef?.AddServerError(nameof(_regModel.Name), "Wymagane");
        if (string.IsNullOrWhiteSpace(_regModel.CompanyName)) formRef?.AddServerError(nameof(_regModel.CompanyName), "Wymagane");
        if (string.IsNullOrWhiteSpace(_regModel.Nip)) formRef?.AddServerError(nameof(_regModel.Nip), "Wymagane");

        var addr = _regModel.Address;
        if (addr == null || string.IsNullOrWhiteSpace(addr.Street) || string.IsNullOrWhiteSpace(addr.City))
        {
            statusMessage = "Uzupełnij wymagane dane adresowe.";
            isError = true;
            return;
        }

        isSubmitting = true;
        statusMessage = "";
        isError = false;

        try
        {
            var request = new RegisterUserRequest(_regModel);
            var result = await AuthService.RegisterAsync(request);

            if (result != null && result.Success)
            {
                _isRegistered = true;
                isError = false;
                return;
            }

            var svcMessage = result?.Message;
            var sanitized = string.IsNullOrWhiteSpace(svcMessage)
                ? "Wystąpił błąd podczas rejestracji."
                : ApiExceptionExtensions.SanitizeMessage(svcMessage);

            if (!sanitized.StartsWith("Błąd"))
                sanitized = "Błąd: " + sanitized;

            statusMessage = sanitized;
            isError = true;
        }
        catch (ApiException aex)
        {
            bool addedAny = false;

            if (!string.IsNullOrWhiteSpace(aex.Response))
            {
                try
                {
                    using var doc = JsonDocument.Parse(aex.Response);
                    if (doc.RootElement.TryGetProperty("errors", out var errorsElement) && errorsElement.ValueKind == JsonValueKind.Object)
                    {
                        foreach (var prop in errorsElement.EnumerateObject())
                        {
                            var rawField = prop.Name;
                            var fieldName = NormalizeFieldName(rawField);
                            foreach (var msgElem in prop.Value.EnumerateArray())
                            {
                                var fieldMsg = msgElem.GetString() ?? "Błąd walidacji";
                                formRef?.AddServerError(fieldName, fieldMsg);
                                addedAny = true;
                            }
                        }

                        if (addedAny)
                        {
                            formRef?.EditContext?.NotifyValidationStateChanged();
                            isError = true;
                            isSubmitting = false;
                            return;
                        }
                    }
                }
                catch
                {
                }
            }

            var userMessage = aex.GetUserMessage();
            if (!userMessage.StartsWith("Błąd"))
                userMessage = "Błąd: " + userMessage;

            statusMessage = userMessage;
            isError = true;
            formRef?.EditContext?.NotifyValidationStateChanged();
        }
        catch (Exception ex)
        {
            var sanitizedEx = ApiExceptionExtensions.SanitizeMessage(ex.Message);
            if (!sanitizedEx.StartsWith("Błąd"))
                sanitizedEx = "Błąd: " + sanitizedEx;

            statusMessage = sanitizedEx;
            isError = true;
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
}