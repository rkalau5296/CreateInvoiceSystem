@page "/products"
@using CreateInvoiceSystem.Frontend.Models
@using CreateInvoiceSystem.Frontend.Services
@using CreateInvoiceSystem.Frontend.Components
@using System.ComponentModel.DataAnnotations
@using System.Globalization
@inject ProductService ProductService

<div class="container-fluid">
    <h3 class="mb-4">Zarządzanie Produktami</h3>

    <div class="row mb-4 align-items-end">
        <div class="col-md-6">
            <label class="form-label small fw-bold">Wyszukaj produkt</label>
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input type="text"
                       class="form-control border-start-0"
                       placeholder="Wpisz nazwę lub opis..."
                       @bind="_searchTerm"
                       @bind:event="oninput"
                       @onkeyup="HandleSearch" />
                @if (!string.IsNullOrWhiteSpace(_searchTerm))
                {
                    <button class="btn btn-outline-secondary border-start-0" @onclick="ClearSearch">
                        <i class="bi bi-x-lg"></i>
                    </button>
                }
            </div>
        </div>

        <div class="col-md-6 text-end">
            <button class="btn btn-outline-secondary me-2" @onclick="ExportToCsv">
                <i class="bi bi-file-earmark-spreadsheet me-1"></i> Eksportuj CSV
            </button>
            <button class="btn btn-primary" @onclick="OpenAddModal">
                <i class="bi bi-plus-circle me-1"></i> Dodaj produkt
            </button>
        </div>
    </div>

    @if (_isModalOpen)
    {
        <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog shadow-lg">
                <div class="modal-content">
                    <ValidatedEditForm TModel="ProductEditModel" Model="_newProductView" OnValidSubmit="HandleSave">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">Dodaj Nowy Produkt</h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <ValidatedInputText @bind-Value="_newProductView.Name"
                                                    Label="Nazwa produktu"
                                                    Placeholder="np. Kawa" />
                            </div>
                            <div class="mb-3">
                                <ValidatedInputText @bind-Value="_newProductView.Description"
                                                    Label="Opis"
                                                    Placeholder="Opcjonalny opis..." />
                            </div>
                            <div class="mb-3">
                                <ValidatedInputText @bind-Value="_newProductView.ValueString"
                                                    Label="Cena"
                                                    Placeholder="0.00"
                                                    Type="number" />
                                <div class="mt-1"><small class="text-muted">PLN</small></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">Anuluj</button>
                            <button type="submit" class="btn btn-success px-4">Zapisz produkt</button>
                        </div>
                    </ValidatedEditForm>
                </div>
            </div>
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-header bg-light">Twoja lista produktów</div>
        <div class="card-body p-0">
            <DataTable Items="_products" Cols="4" TableClass="table table-hover mb-0" HeaderClass="table-dark" KeySelector="p => p.ProductId" NoItemsMessage="Brak produktów w bazie.">
                <HeaderTemplate>
                    <tr>
                        <th style="width: 25%">Nazwa</th>
                        <th style="width: 40%">Opis</th>
                        <th style="width: 15%" class="text-end">Cena</th>
                        <th style="width: 20%" class="text-center">Akcje</th>
                    </tr>
                </HeaderTemplate>

                <RowTemplate Context="p">
                    @if (_editingProductId == p.ProductId)
                    {
                        <td colspan="4" class="p-2">
                            <ValidatedEditForm TModel="ProductEditModel" Model="_editViewModel" OnValidSubmit="SubmitInlineEdit">
                                <div class="editing-grid">
                                    <div>
                                        <ValidatedInputText @bind-Value="_editViewModel.Name" Placeholder="Nazwa" />
                                    </div>
                                    <div>
                                        <ValidatedInputText @bind-Value="_editViewModel.Description" Placeholder="Opis" />
                                    </div>
                                    <div class="text-end">
                                        <ValidatedInputText @bind-Value="_editViewModel.ValueString" Placeholder="Wartość" Type="number" />
                                    </div>
                                    <div class="text-center">
                                        <div class="d-flex justify-content-center gap-2">
                                            <button type="submit" class="btn btn-sm btn-success px-3 shadow-sm">
                                                <i class="bi bi-check-lg"></i> Zapisz
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary px-3" @onclick="CancelEdit">
                                                Anuluj
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </ValidatedEditForm>
                        </td>
                    }
                    else
                    {
                        <td class="align-middle"><strong>@p.Name</strong></td>
                        <td class="align-middle text-truncate" style="max-width: 300px;">@p.Description</td>
                        <td class="align-middle text-end">@p.Value?.ToString("N2") PLN</td>
                        <td class="text-center align-middle">
                            <div class="d-flex justify-content-center gap-2">
                                <button class="btn btn-sm btn-primary px-3 shadow-sm" @onclick="() => StartEdit(p)">
                                    <i class="bi bi-pencil-square me-1"></i> Edytuj
                                </button>
                                <button class="btn btn-sm btn-danger px-3 shadow-sm" @onclick="() => HandleDelete(p.ProductId)">
                                    <i class="bi bi-trash me-1"></i> Usuń
                                </button>
                            </div>
                        </td>
                    }
                </RowTemplate>
            </DataTable>
        </div>
    </div>
</div>

<style>
    .tiny {
        font-size: 0.75rem;
    }

    .editing-grid {
        display: grid;
        grid-template-columns: 25% 40% 15% 20%;
        gap: 8px;
        align-items: center;
    }

        .editing-grid .form-control {
            height: calc(1.5em + 0.5rem);
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

    .editing-row td {
        vertical-align: middle;
    }
</style>

<Pagination ItemsOnPageCount="@(_products?.Count ?? 0)"
            TotalItems="@_totalCount"
            CurrentPage="@_currentPage"
            CurrentPageChanged="ChangePage"
            PageSize="@_pageSize"
            PageSizeChanged="ChangePageSize"
            ItemLabel="produktów" />

@code {
    private List<ProductDto>? _products;
    private int? _editingProductId;
    private ProductDto _newProduct = new();
    private ProductEditModel _newProductView = new();
    private ProductDto _editModel = new();
    private ProductEditModel _editViewModel = new();
    private int _pageSize = 10;
    private int _currentPage = 1;
    private int _totalCount = 0;
    private int _totalPages => (int)Math.Ceiling((double)_totalCount / _pageSize);
    private string _searchTerm = "";
    private System.Timers.Timer? _searchTimer;
    private bool _isModalOpen = false;

    private void OpenAddModal()
    {
        _newProduct = new ProductDto { Name = "", Value = null, Description = "" };
        _newProductView = new ProductEditModel
        {
            Name = _newProduct.Name,
            Description = _newProduct.Description,
            ValueString = _newProduct.Value?.ToString(CultureInfo.InvariantCulture) ?? ""
        };
        _isModalOpen = true;
    }

    private void CloseModal() => _isModalOpen = false;

    private async Task LoadData()
    {
        var response = await ProductService.GetProductsAsync(_currentPage, _pageSize, _searchTerm);
        _products = response.Data;
        _totalCount = response.TotalCount;
        StateHasChanged();
    }

    private async Task HandleSave()
    {
        try
        {
            if (!TryBuildDtoFromView(_newProductView, out var dto, out var err))
            {
                Console.WriteLine($"Walidacja: {err}");
                return;
            }

            await ProductService.SaveProductAsync(dto);
            _isModalOpen = false;
            _newProduct = new ProductDto();
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Błąd zapisu: {ex.Message}");
        }
    }

    private void HandleSearch()
    {
        _searchTimer?.Stop();
        _searchTimer?.Dispose();
        _searchTimer = new System.Timers.Timer(400);
        _searchTimer.Elapsed += async (s, e) =>
        {
            _searchTimer.Stop();
            _currentPage = 1;
            await InvokeAsync(LoadData);
        };
        _searchTimer.Start();
    }

    private async Task ClearSearch() { _searchTerm = ""; _currentPage = 1; await LoadData(); }
    private async Task ChangePage(int newPage) { if (newPage < 1) newPage = 1; _currentPage = newPage; await LoadData(); }

    private async Task ChangePageSize(int newSize)
    {
        if (newSize <= 0) return;
        _pageSize = newSize;
        _currentPage = 1;
        await LoadData();
    }

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task HandleDelete(int productId)
    {
        try { await ProductService.DeleteProductAsync(productId); await LoadData(); }
        catch (Exception ex) { Console.WriteLine($"Błąd: {ex.Message}"); }
    }

    private void StartEdit(ProductDto product)
    {
        _editingProductId = product.ProductId;
        _editModel = new ProductDto
        {
            ProductId = product.ProductId,
            Name = product.Name,
            Description = product.Description,
            Value = product.Value,
            UserId = product.UserId
        };

        _editViewModel = new ProductEditModel
        {
            ProductId = _editModel.ProductId,
            UserId = _editModel.UserId,
            Name = _editModel.Name,
            Description = _editModel.Description,
            ValueString = _editModel.Value?.ToString(CultureInfo.InvariantCulture) ?? ""
        };
    }

    private void CancelEdit()
    {
        _editingProductId = null;
    }

    private async Task SubmitInlineEdit()
    {
        if (!TryBuildDtoFromView(_editViewModel, out var dto, out var err))
        {
            Console.WriteLine($"Walidacja: {err}");
            return;
        }

        dto.ProductId = _editViewModel.ProductId;
        dto.UserId = _editViewModel.UserId;

        await ProductService.UpdateProductAsync(dto);
        _editingProductId = null;
        await LoadData();
    }

    private async Task ExportToCsv()
    {
        try { await ProductService.DownloadProductsCsvAsync(); }
        catch (Exception ex) { Console.WriteLine($"Błąd eksportu: {ex.Message}"); }
    }

    private bool TryBuildDtoFromView(ProductEditModel vm, out ProductDto dto, out string? error)
    {
        error = null;
        dto = new ProductDto();

        if (string.IsNullOrWhiteSpace(vm.Name))
        {
            error = "Nazwa jest wymagana.";
            return false;
        }

        var s = (vm.ValueString ?? "").Trim().Replace(',', '.');
        if (!decimal.TryParse(s, NumberStyles.AllowDecimalPoint | NumberStyles.AllowLeadingSign, CultureInfo.InvariantCulture, out var val))
        {
            error = "Nieprawidłowa wartość ceny.";
            return false;
        }

        dto.ProductId = vm.ProductId;
        dto.UserId = vm.UserId;
        dto.Name = vm.Name;
        dto.Description = vm.Description;
        dto.Value = val;
        return true;
    }

    public class ProductEditModel : IValidatableObject
    {
        public int ProductId { get; set; }
        public int UserId { get; set; }

        [Required(ErrorMessage = "Nazwa jest wymagana.")]
        public string Name { get; set; } = string.Empty;

        public string Description { get; set; } = string.Empty;

        [Required(ErrorMessage = "Cena jest wymagana.")]
        public string ValueString { get; set; } = string.Empty;

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            var results = new List<ValidationResult>();

            var s = (ValueString ?? string.Empty).Trim().Replace(',', '.');
            if (!decimal.TryParse(s, NumberStyles.AllowDecimalPoint | NumberStyles.AllowLeadingSign, CultureInfo.InvariantCulture, out var val))
            {
                results.Add(new ValidationResult("Nieprawidłowa wartość ceny.", new[] { nameof(ValueString) }));
                return results;
            }

            if (val < 0m)
            {
                results.Add(new ValidationResult("Cena nie może być ujemna.", new[] { nameof(ValueString) }));
            }

            return results;
        }
    }
}